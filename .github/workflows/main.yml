name: blog_notifier

on:
  workflow_dispatch: {}  # optional manual trigger
  push:
    paths:
      - 'src/content/blog/*'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Wait for Vercel deployment
      - name: Wait for Vercel Deployment
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          wait-for-approval: false
        id: vercel

      # Restore cache of processed files
      - name: Restore processed files cache
        id: cache
        uses: actions/cache@v3
        with:
          path: .github/workflows/processed_files.json
          key: blog-notifier-${{ runner.os }}-v1
          restore-keys: |
            blog-notifier-${{ runner.os }}-v1

      # Initialize processed files list
      - name: Initialize processed files
        id: init
        run: |
          FILE=".github/workflows/processed_files.json"
          if [ ! -f $FILE ]; then
            echo "[]" > $FILE
          fi

      # Get all blog files
      - name: Get all blog files
        id: all-files
        run: |
          FILES=$(find src/content/blog -type f | base64 -w0)
          echo "all_files=$FILES" >> $GITHUB_OUTPUT
      # Determine unprocessed files
      - name: Determine unprocessed files
        id: unprocessed
        run: |
          FILE=".github/workflows/processed_files.json"
          PROCESSED=$(cat $FILE)
          NEW_FILES=""
          for f in ${{ steps.all-files.outputs.all_files }}; do
            if ! echo "$PROCESSED" | grep -q "$f"; then
              NEW_FILES="$NEW_FILES $f"
            fi
          done
          echo "new_files=$NEW_FILES" >> $GITHUB_OUTPUT
          echo "Unprocessed files: $NEW_FILES"

      # Send emails for new files
      - name: Send Email for New Files
        if: steps.unprocessed.outputs.new_files != ''
        run: |
          FILE=".github/workflows/processed_files.json"
          for file in ${{ steps.unprocessed.outputs.new_files }}; do
            echo "Processing $file..."
            # Append to processed record
            jq --arg f "$file" '. += [$f]' $FILE > tmp.json && mv tmp.json $FILE
          done

      # Save updated processed files to cache
      - name: Save cache
        uses: actions/cache@v3
        with:
          path: .github/workflows/processed_files.json
          key: blog-notifier-${{ runner.os }}-v1
