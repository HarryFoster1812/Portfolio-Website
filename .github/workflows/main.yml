name: blog_notifier

permissions:
  contents: write

on:
  workflow_dispatch: {}
  push:
    paths:
      - 'src/content/blog/*'


jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Wait for Vercel Deployment
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          wait-for-approval: false
        id: vercel

  notify:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MAILTRAP_API_KEY: ${{ secrets.MAILTRAP_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Initialize processed files list (repo-backed)
      - name: Initialize processed files
        run: |
          FILE=".github/state/processed_files.json"
          if [ ! -f "$FILE" ]; then
            echo "[]" > "$FILE"
          fi

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Get all blog files (ignore dotfiles)
      - name: Get all blog files
        id: all-files
        run: |
          FILES=$(find src/content/blog -type f ! -name ".*" ! -path "*/.*" | base64 -w0)
          echo "all_files=$FILES" >> $GITHUB_OUTPUT

      # Determine unprocessed files
      - name: Determine unprocessed files
        id: unprocessed
        run: |
          FILE=".github/state/processed_files.json"
          NEW_FILES=""
          while read -r f; do
            if ! grep -q "$f" "$FILE"; then
              NEW_FILES="$NEW_FILES $f"
            fi
          done < <(echo "${{ steps.all-files.outputs.all_files }}" | base64 --decode)

          NEW_FILES_CSV=$(echo "$NEW_FILES" | xargs | tr ' ' ',')
          echo "new_files=$NEW_FILES_CSV" >> $GITHUB_OUTPUT
          echo "Unprocessed files: $NEW_FILES_CSV"

      # Fetch confirmed users once
      - name: Get confirmed users
        id: users
        if: steps.unprocessed.outputs.new_files != ''
        run: |
          USERS_JSON=$(node ./scripts/get_confirmed_users.mjs)
          echo "users=$USERS_JSON" >> $GITHUB_OUTPUT

      # Send emails for new files
      - name: Send emails
        if: steps.unprocessed.outputs.new_files != '' && steps.users.outputs.users != '[]'
        run: |
          IFS=',' read -ra FILE_ARRAY <<< "${{ steps.unprocessed.outputs.new_files }}"
          for file in "${FILE_ARRAY[@]}"; do
            node ./scripts/send_blog_update_email.mjs "$file" '${{ steps.users.outputs.users }}'

            # Mark file as processed
            jq --arg f "$file" '. += [$f]' \
              .github/state/processed_files.json > tmp.json \
              && mv tmp.json .github/state/processed_files.json
          done

      # Commit processed files (long-term persistence)
      - name: Commit processed files
        run: |
          FILE=".github/state/processed_files.json"

          if git diff --quiet "$FILE"; then
            echo "No changes to processed files"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          git commit -m "chore: update processed blog files"
          git push
